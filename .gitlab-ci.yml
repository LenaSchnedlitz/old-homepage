image: cypress/base:12.16.1

# VARIABLES AND CACHE #

variables:
  DEPLOY_USER: 'LenaSchnedlitz'
  DEPLOY_REPO_NAME: 'LenaSchnedlitz.github.io'

cache:
  key: the-one-and-only-cache-key
  paths:
    - .npm
    - cache/Cypress
    - node_modules

before_script:
  - npm ci --cache .npm --prefer-offline
  - npx cypress cache path
  - npx cypress cache list


# JOBS #

stages:
  - test
  - deploy


test:
  stage: test
  before_script:
    - npm ci --cache .npm --prefer-offline
    - npx cypress cache path
    - npx cypress cache list
  script:
    - npm run cy:verify
    - npm run test

deploy:
  stage: deploy
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run export
    # clone deploy repo and throw away all content but .git/ and CNAME
    - git clone https://github.com/${DEPLOY_USER}/${DEPLOY_REPO_NAME}.git
    - mv ${DEPLOY_REPO_NAME} ${DEPLOY_REPO_NAME}-old
    - mkdir ${DEPLOY_REPO_NAME}
    - mv -t ${DEPLOY_REPO_NAME} ${DEPLOY_REPO_NAME}-old/.git ${DEPLOY_REPO_NAME}-old/CNAME
    # add newly built content
    - cp -rf __sapper__/export/* ${DEPLOY_REPO_NAME}
    - cd ${DEPLOY_REPO_NAME}
    - git add .
    # commit and push
    - git config user.name "Lena Schnedlitz"
    - git config user.email ${GITLAB_USER_EMAIL}
    - git commit -m ${CI_COMMIT_SHORT_SHA}
    - git push https://LenaSchnedlitz:${DEPLOY_TOKEN}@github.com/${DEPLOY_USER}/${DEPLOY_REPO_NAME}.git HEAD
  only:
    - master
